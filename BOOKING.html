<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Booking & Chia Phòng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background-color: #f1f5f9;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 18px 20px;
            background: none;
            border: none;
            font-size: 17px;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button:hover {
            background-color: #e8eff5;
        }
        
        .tab-button.active {
            background-color: white;
            color: #2c3e50;
            border-bottom: 3px solid #9ACD32;
        }
        
        .tab-content {
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 22px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #9ACD32;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input, select, button, textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #9ACD32;
            outline: none;
        }
        
        input.uppercase {
            text-transform: uppercase;
        }
        
        textarea.uppercase {
            text-transform: uppercase;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .btn {
            padding: 13px 25px;
            background-color: #9ACD32;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #7f8c8d;
        }
        
        .btn-secondary:hover {
            background-color: #6c7b7d;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .booking-list, .tour-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        .booking-card, .tour-card {
            background-color: #f9fbfd;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e1e8f0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            position: relative;
        }
        
        .booking-card:hover, .tour-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .booking-header, .tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .booking-title, .tour-title {
            font-weight: 700;
            font-size: 20px;
            color: #2c3e50;
        }
        
        .booking-customer-count, .tour-customer-count {
            background-color: #9ACD32;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .room-assignment-section {
            margin-top: 20px;
        }
        
        .room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .room-card {
            background-color: white;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #e1e8f0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eaeaea;
        }
        
        .room-title {
            font-weight: 700;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .room-capacity {
            background-color: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 13px;
        }
        
        .staff-list {
            list-style-type: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .staff-list li {
            padding: 8px 10px;
            background-color: #f8f9fa;
            margin-bottom: 6px;
            border-radius: 4px;
            border-left: 4px solid #9ACD32;
            font-size: 14px;
        }
        
        .duplicate-warning {
            color: #e74c3c;
            font-weight: 600;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background-color: #fdf2f2;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .stat-card {
            background-color: #f9fbfd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e1e8f0;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #9ACD32;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background-color: #d5edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: #2c3e50;
        }
        
        tr:hover {
            background-color: #f9fbfd;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d5edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .today-date {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 10px;
            text-align: center;
        }
        
        .booking-details, .tour-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #555;
        }
        
        .detail-value {
            color: #333;
            flex: 1;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .staff-off-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #eaeaea;
        }
        
        .staff-off-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .staff-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #9ACD32;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .booking-status-future {
            border-left: 5px solid #9ACD32;
        }
        
        .booking-status-today {
            border-left: 5px solid #27ae60;
        }
        
        .booking-status-past {
            border-left: 5px solid #95a5a6;
        }
        
        .tab-submenu {
            display: flex;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .submenu-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .submenu-btn:hover {
            background-color: #e9ecef;
        }
        
        .submenu-btn.active {
            background-color: #9ACD32;
            color: white;
        }
        
        .room-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .btn-remove-room {
            padding: 5px 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        
        .btn-remove-room:hover {
            background-color: #c0392b;
        }
        
        .duration-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .duration-input {
            flex: 1;
        }
        
        .duration-unit {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        
        /* Thêm style mới cho cảnh báo trùng lịch */
        .schedule-conflict {
            background-color: #fff8e1;
            border: 1px solid #ffd54f;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .schedule-conflict i {
            color: #ff9800;
            margin-right: 8px;
        }
        
        .current-tours-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .current-tour-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 5px solid #9ACD32;
            border: 1px solid #e1e8f0;
        }
        
        .tour-time-range {
            background-color: #e3f2fd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .conflict-alert {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .data-management {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid #eaeaea;
        }
        
        /* Nút xóa booking */
        .btn-delete-booking {
    padding: 5px 10px;
    background-color: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.3s;
    z-index: 10;
    margin-top: 10px;  
    width: 100%;       
}
        
        .btn-delete-booking:hover {
            background-color: #c0392b;
        }
        
        .delete-booking-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .btn-delete-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .booking-list, .tour-list, .room-list, .current-tours-list {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                padding: 15px 10px;
                font-size: 14px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tab-submenu {
                flex-direction: column;
            }
            
            .duration-input-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-delete-booking {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hotel"></i> ỨNG DỤNG QUẢN LÝ BOOKING MYGREEN</h1>
            <p>QUẢN LÝ 50 NHÂN VIÊN VÀ PHÂN CHIA VÀO CÁC PHÒNG 2-6 NGƯỜI</p>
            <div class="today-date" id="todayDate"></div>
        </header>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="booking">
                <i class="fas fa-calendar-check"></i> NHẬN BOOKING
            </button>
            <button class="tab-button" data-tab="room-assignment">
                <i class="fas fa-door-open"></i> CHIA PHÒNG
            </button>
            <button class="tab-button" data-tab="current-tours">
                <i class="fas fa-running"></i> TOUR ĐANG DIỄN RA
            </button>
            <button class="tab-button" data-tab="future-bookings">
                <i class="fas fa-calendar-alt"></i> BOOKING TƯƠNG LAI
            </button>
            <button class="tab-button" data-tab="staff-off">
                <i class="fas fa-user-slash"></i> NHÂN VIÊN OFF
            </button>
            <button class="tab-button" data-tab="statistics">
                <i class="fas fa-chart-bar"></i> THỐNG KÊ
            </button>
            <button class="tab-button" data-tab="data-management">
                <i class="fas fa-database"></i> QUẢN LÝ DỮ LIỆU
            </button>
        </div>
        
        <!-- Tab Nhận Booking -->
        <div id="booking" class="tab-content active">
            <h2 class="section-title"><i class="fas fa-calendar-plus"></i> THÔNG TIN BOOKING</h2>
            
            <div id="bookingAlert" class="alert" style="display:none;"></div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="tourName"><i class="fas fa-map-marked-alt"></i> TÊN BOOKING/TOUR</label>
                        <input type="text" id="tourName" class="uppercase" placeholder="NHẬP TÊN BOOKING/TOUR...">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="tourDate"><i class="fas fa-calendar-day"></i> NGÀY BOOKING</label>
                        <input type="date" id="tourDate">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="tourTime"><i class="fas fa-clock"></i> THỜI GIAN BẮT ĐẦU</label>
                        <input type="time" id="tourTime">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="durationMinutes"><i class="fas fa-hourglass-half"></i> THỜI LƯỢNG (PHÚT)</label>
                        <div class="duration-input-container">
                            <input type="number" id="durationMinutes" min="15" max="480" placeholder="VD: 60, 90, 120..." class="duration-input">
                            <span class="duration-unit">PHÚT</span>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="customerCount"><i class="fas fa-users"></i> SỐ LƯỢNG KHÁCH</label>
                        <input type="number" id="customerCount" min="1" max="100" placeholder="SỐ LƯỢNG KHÁCH...">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="tourNotes"><i class="fas fa-sticky-note"></i> GHI CHÚ</label>
                <textarea id="tourNotes" rows="3" class="uppercase" placeholder="GHI CHÚ THÊM VỀ BOOKING..."></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn" id="saveBookingBtn">
                    <i class="fas fa-save"></i> LƯU BOOKING
                </button>
                <button class="btn btn-secondary" id="clearBookingBtn">
                    <i class="fas fa-broom"></i> XÓA FORM
                </button>
            </div>
            
            <div class="form-group" style="margin-top: 40px;">
                <h2 class="section-title"><i class="fas fa-list"></i> DANH SÁCH BOOKING HÔM NAY</h2>
                
                <div id="todayBookingsList" class="booking-list">
                    <!-- Các booking hôm nay sẽ hiển thị ở đây -->
                </div>
            </div>
            
            <!-- Phần xóa booking (ẩn/modal style) -->
            <div id="deleteBookingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background-color: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px;"><i class="fas fa-exclamation-triangle"></i> XÁC NHẬN XÓA BOOKING</h3>
                    <p id="deleteBookingMessage" style="margin-bottom: 20px;"></p>
                    <div class="delete-booking-buttons">
                        <button class="btn btn-danger" id="confirmDeleteBookingBtn">
                            <i class="fas fa-trash"></i> XÓA BOOKING
                        </button>
                        <button class="btn btn-secondary" id="cancelDeleteBookingBtn">
                            <i class="fas fa-times"></i> HỦY BỎ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Chia Phòng -->
        <div id="room-assignment" class="tab-content">
            <h2 class="section-title"><i class="fas fa-door-closed"></i> PHÂN CHIA PHÒNG</h2>
            
            <div id="roomAlert" class="alert" style="display:none;"></div>
            
            <div class="form-group">
                <label for="selectBooking"><i class="fas fa-calendar-alt"></i> CHỌN BOOKING</label>
                <select id="selectBooking">
                    <option value="">-- CHỌN BOOKING ĐỂ CHIA PHÒNG --</option>
                </select>
            </div>
            
            <div id="bookingInfoBox" style="display: none;">
                <div class="booking-card">
                    <div class="booking-header">
                        <div class="booking-title" id="selectedBookingName"></div>
                        <div class="booking-customer-count" id="selectedBookingCustomerCount"></div>
                    </div>
                    <div class="booking-details">
                        <div class="detail-row">
                            <div class="detail-label">NGÀY & GIỜ:</div>
                            <div class="detail-value" id="selectedBookingDateTime"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">THỜI LƯỢNG:</div>
                            <div class="detail-value" id="selectedBookingDuration"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">TRẠNG THÁI:</div>
                            <div class="detail-value"><span id="selectedBookingStatus" class="badge"></span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">NV ĐÃ PHÂN:</div>
                            <div class="detail-value" id="selectedBookingAssignedStaff"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="showDeleteBookingModal(selectedBookingId)">
                            <i class="fas fa-trash"></i> XÓA BOOKING NÀY
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="roomAssignmentSection" style="display: none; margin-top: 30px;">
                <h2 class="section-title"><i class="fas fa-user-plus"></i> PHÂN CHIA PHÒNG</h2>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="roomNumber"><i class="fas fa-door-closed"></i> SỐ PHÒNG</label>
                            <input type="text" id="roomNumber" class="uppercase" placeholder="VD: P101, P102...">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="roomCapacity"><i class="fas fa-user-friends"></i> SỨC CHỨA</label>
                            <select id="roomCapacity">
                                <option value="2">2 NGƯỜI</option>
                                <option value="3">3 NGƯỜI</option>
                                <option value="4">4 NGƯỜI</option>
                                <option value="5" selected>5 NGƯỜI</option>
                                <option value="6">6 NGƯỜI</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="staffCodes"><i class="fas fa-id-badge"></i> TÊN/MÃ NHÂN VIÊN (PHÂN CÁCH BẰNG DẤU PHẨY)</label>
                    <input type="text" id="staffCodes" class="uppercase" placeholder="VD: ANH TUẤN, CHỊ MAI, 001, 002...">
                    <div id="duplicateWarning" class="duplicate-warning" style="display:none;">
                        <i class="fas fa-exclamation-triangle"></i> CẢNH BÁO: MỘT SỐ NHÂN VIÊN ĐÃ ĐƯỢC PHÂN CÔNG VÀO PHÒNG KHÁC!
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn" id="assignRoomBtn">
                        <i class="fas fa-user-plus"></i> THÊM PHÒNG
                    </button>
                    <button class="btn btn-success" id="autoAssignBtn">
                        <i class="fas fa-robot"></i> TỰ ĐỘNG CHIA PHÒNG
                    </button>
                    <button class="btn btn-warning" id="markCompleteBtn">
                        <i class="fas fa-check-circle"></i> ĐÁNH DẤU HOÀN THÀNH
                    </button>
                    <button class="btn btn-secondary" id="clearRoomFormBtn">
                        <i class="fas fa-times"></i> XÓA FORM
                    </button>
                </div>
                
                <div class="room-assignment-section">
                    <h3 class="section-title" style="font-size: 18px; margin-top: 30px;">
                        <i class="fas fa-hotel"></i> PHÒNG ĐÃ PHÂN CÔNG
                    </h3>
                    <div id="bookingRoomsList" class="room-list">
                        <!-- Các phòng đã phân công sẽ hiển thị ở đây -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab TOUR ĐANG DIỄN RA -->
        <div id="current-tours" class="tab-content">
            <h2 class="section-title"><i class="fas fa-running"></i> TOUR ĐANG DIỄN RA</h2>
            
            <div id="currentToursAlert" class="alert" style="display:none;"></div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="filterCurrentDate"><i class="fas fa-calendar"></i> LỌC THEO NGÀY</label>
                        <input type="date" id="filterCurrentDate">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="filterCurrentTime"><i class="fas fa-clock"></i> LỌC THEO GIỜ HIỆN TẠI</label>
                        <input type="time" id="filterCurrentTime">
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" id="refreshCurrentToursBtn">
                    <i class="fas fa-sync-alt"></i> LÀM MỚI DANH SÁCH
                </button>
                <button class="btn btn-secondary" id="showAllCurrentToursBtn">
                    <i class="fas fa-eye"></i> HIỂN THỊ TẤT CẢ
                </button>
                <button class="btn btn-success" id="showNowToursBtn">
                    <i class="fas fa-clock"></i> HIỆN TẠI
                </button>
            </div>
            
            <div class="form-group" style="margin-top: 30px;">
                <h3 class="section-title" style="font-size: 18px;">
                    <i class="fas fa-list"></i> DANH SÁCH TOUR ĐANG DIỄN RA
                </h3>
                
                <div id="currentToursList" class="current-tours-list">
                    <!-- Danh sách tour đang diễn ra sẽ hiển thị ở đây -->
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 40px;">
                <h3 class="section-title" style="font-size: 18px;">
                    <i class="fas fa-user-tie"></i> NHÂN VIÊN ĐANG LÀM VIỆC
                </h3>
                
                <div id="currentStaffList" class="current-tours-list">
                    <!-- Danh sách nhân viên đang làm việc sẽ hiển thị ở đây -->
                </div>
            </div>
        </div>
        
        <!-- Tab Booking Tương Lai -->
        <div id="future-bookings" class="tab-content">
            <h2 class="section-title"><i class="fas fa-calendar-alt"></i> BOOKING TƯƠNG LAI</h2>
            
            <div class="filter-section">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="filterDate"><i class="fas fa-filter"></i> LỌC THEO NGÀY</label>
                            <input type="date" id="filterDate">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="filterStatus"><i class="fas fa-filter"></i> LỌC THEO TRẠNG THÁI</label>
                            <select id="filterStatus">
                                <option value="all">TẤT CẢ TRẠNG THÁI</option>
                                <option value="chua_phan_phong">CHƯA PHÂN PHÒNG</option>
                                <option value="dang_phan_phong">ĐANG PHÂN PHÒNG</option>
                                <option value="hoan_thanh">HOÀN THÀNH</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn" id="applyFilterBtn">
                        <i class="fas fa-filter"></i> ÁP DỤNG LỌC
                    </button>
                    <button class="btn btn-secondary" id="resetFilterBtn">
                        <i class="fas fa-redo"></i> ĐẶT LẠI LỌC
                    </button>
                </div>
            </div>
            
            <div class="tab-submenu">
                <button class="submenu-btn active" data-subtab="upcoming">SẮP TỚI</button>
                <button class="submenu-btn" data-subtab="this-week">TUẦN NÀY</button>
                <button class="submenu-btn" data-subtab="next-week">TUẦN SAU</button>
                <button class="submenu-btn" data-subtab="all-future">TẤT CẢ TƯƠNG LAI</button>
            </div>
            
            <div id="futureBookingsList" class="booking-list">
                <!-- Các booking tương lai sẽ hiển thị ở đây -->
            </div>
        </div>
        
        <!-- Tab Nhân Viên Off -->
        <div id="staff-off" class="tab-content">
            <h2 class="section-title"><i class="fas fa-user-slash"></i> QUẢN LÝ NHÂN VIÊN OFF</h2>
            
            <div id="staffOffAlert" class="alert" style="display:none;"></div>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="staffSelect"><i class="fas fa-user"></i> CHỌN NHÂN VIÊN</label>
                        <select id="staffSelect">
                            <option value="">-- CHỌN NHÂN VIÊN --</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="offDate"><i class="fas fa-calendar-times"></i> NGÀY OFF</label>
                        <input type="date" id="offDate">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="offReason"><i class="fas fa-sticky-note"></i> LÝ DO OFF (TÙY CHỌN)</label>
                <textarea id="offReason" rows="2" class="uppercase" placeholder="NHẬP LÝ DO NHÂN VIÊN OFF..."></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-warning" id="markOffBtn">
                    <i class="fas fa-user-slash"></i> ĐÁNH DẤU OFF
                </button>
                <button class="btn btn-success" id="markAvailableBtn">
                    <i class="fas fa-user-check"></i> ĐÁNH DẤU CÓ MẶT
                </button>
                <button class="btn btn-secondary" id="clearOffFormBtn">
                    <i class="fas fa-times"></i> XÓA FORM
                </button>
            </div>
            
            <div class="form-group" style="margin-top: 40px;">
                <h2 class="section-title"><i class="fas fa-calendar-times"></i> DANH SÁCH NHÂN VIÊN OFF HÔM NAY</h2>
                
                <div id="todayOffStaffList">
                    <!-- Danh sách nhân viên off hôm nay sẽ hiển thị ở đây -->
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 40px;">
                <h2 class="section-title"><i class="fas fa-calendar-alt"></i> LỊCH OFF TRONG TUẦN</h2>
                
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="offFilterDate"><i class="fas fa-calendar"></i> XEM OFF THEO NGÀY</label>
                                <input type="date" id="offFilterDate">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="offFilterStaff"><i class="fas fa-user"></i> LỌC THEO NHÂN VIÊN</label>
                                <input type="text" id="offFilterStaff" class="uppercase" placeholder="NHẬP TÊN HOẶC MÃ NV...">
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn" id="applyOffFilterBtn">
                            <i class="fas fa-filter"></i> ÁP DỤNG LỌC
                        </button>
                        <button class="btn btn-secondary" id="resetOffFilterBtn">
                            <i class="fas fa-redo"></i> ĐẶT LẠI LỌC
                        </button>
                    </div>
                </div>
                
                <table id="offScheduleTable">
                    <thead>
                        <tr>
                            <th>NHÂN VIÊN</th>
                            <th>NGÀY OFF</th>
                            <th>LÝ DO</th>
                            <th>TRẠNG THÁI</th>
                            <th>THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody id="offScheduleBody">
                        <!-- Lịch off sẽ hiển thị ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Thống Kê -->
        <div id="statistics" class="tab-content">
            <h2 class="section-title"><i class="fas fa-chart-pie"></i> THỐNG KÊ HOẠT ĐỘNG</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users fa-2x" style="color: #9ACD32;"></i>
                    <div class="stat-number" id="totalStaff">50</div>
                    <div class="stat-label">TỔNG NHÂN VIÊN</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-slash fa-2x" style="color: #e74c3c;"></i>
                    <div class="stat-number" id="offStaffToday">0</div>
                    <div class="stat-label">NV OFF HÔM NAY</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-day fa-2x" style="color: #2ecc71;"></i>
                    <div class="stat-number" id="totalBookingsToday">0</div>
                    <div class="stat-label">BOOKING HÔM NAY</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-alt fa-2x" style="color: #f39c12;"></i>
                    <div class="stat-number" id="futureBookingsCount">0</div>
                    <div class="stat-label">BOOKING TƯƠNG LAI</div>
                </div>
            </div>
            
            <h2 class="section-title" style="margin-top: 40px;">
                <i class="fas fa-user-tie"></i> THỐNG KÊ NHÂN VIÊN
            </h2>
            
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="statDate"><i class="fas fa-calendar"></i> CHỌN NGÀY</label>
                        <input type="date" id="statDate">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="statStaffCode"><i class="fas fa-id-card"></i> LỌC THEO TÊN/MÃ NV (TÙY CHỌN)</label>
                        <input type="text" id="statStaffCode" class="uppercase" placeholder="VD: ANH TUẤN, 001, NV001">
                    </div>
                </div>
            </div>
            
            <table id="statsTable">
                <thead>
                    <tr>
                        <th>TÊN/MÃ NV</th>
                        <th>TÊN NHÂN VIÊN</th>
                        <th>SỐ BOOKING</th>
                        <th>PHÒNG ĐÃ PHÂN</th>
                        <th>TRẠNG THÁI HÔM NAY</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <!-- Dữ liệu thống kê sẽ được thêm ở đây -->
                </tbody>
            </table>
            
            <div class="action-buttons" style="margin-top: 30px;">
                <button class="btn" id="refreshStatsBtn">
                    <i class="fas fa-sync-alt"></i> LÀM MỚI THỐNG KÊ
                </button>
                <button class="btn btn-secondary" id="exportStatsBtn">
                    <i class="fas fa-file-export"></i> XUẤT THỐNG KÊ
                </button>
            </div>
        </div>
        
        <!-- Tab Quản Lý Dữ Liệu (MỚI) -->
        <div id="data-management" class="tab-content">
            <h2 class="section-title"><i class="fas fa-database"></i> QUẢN LÝ DỮ LIỆU</h2>
            
            <div id="dataAlert" class="alert" style="display:none;"></div>
            
            <div class="data-management">
                <h3 class="section-title" style="font-size: 18px;">
                    <i class="fas fa-save"></i> LƯU DỮ LIỆU
                </h3>
                
                <p>Dữ liệu sẽ tự động được lưu vào bộ nhớ trình duyệt (localStorage). 
                Bạn có thể sử dụng các chức năng bên dưới để quản lý dữ liệu:</p>
                
                <div class="action-buttons">
                    <button class="btn btn-success" id="saveDataBtn">
                        <i class="fas fa-save"></i> LƯU DỮ LIỆU NGAY
                    </button>
                    <button class="btn" id="loadDataBtn">
                        <i class="fas fa-download"></i> TẢI LẠI DỮ LIỆU
                    </button>
                    <button class="btn btn-danger" id="clearDataBtn">
                        <i class="fas fa-trash"></i> XÓA TẤT CẢ DỮ LIỆU
                    </button>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <h3 class="section-title" style="font-size: 18px;">
                        <i class="fas fa-file-export"></i> XUẤT DỮ LIỆU
                    </h3>
                    
                    <p>Xuất dữ liệu ra file JSON để lưu trữ hoặc chia sẻ:</p>
                    
                    <div class="action-buttons">
                        <button class="btn btn-warning" id="exportAllDataBtn">
                            <i class="fas fa-file-export"></i> XUẤT TẤT CẢ DỮ LIỆU
                        </button>
                        <button class="btn btn-warning" id="exportBookingsBtn">
                            <i class="fas fa-calendar-export"></i> XUẤT BOOKING
                        </button>
                        <button class="btn btn-warning" id="exportStaffBtn">
                            <i class="fas fa-users-export"></i> XUẤT NHÂN VIÊN
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <h3 class="section-title" style="font-size: 18px;">
                        <i class="fas fa-file-import"></i> NHẬP DỮ LIỆU
                    </h3>
                    
                    <p>Nhập dữ liệu từ file JSON (chỉ hỗ trợ định dạng đúng):</p>
                    
                    <div class="form-group">
                        <label for="importFile"><i class="fas fa-file-import"></i> CHỌN FILE JSON</label>
                        <input type="file" id="importFile" accept=".json">
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" id="importDataBtn">
                            <i class="fas fa-file-import"></i> NHẬP DỮ LIỆU
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <h3 class="section-title" style="font-size: 18px;">
                        <i class="fas fa-info-circle"></i> THÔNG TIN DỮ LIỆU HIỆN TẠI
                    </h3>
                    
                    <div id="dataInfo">
                        <div class="detail-row">
                            <div class="detail-label">Tổng số Booking:</div>
                            <div class="detail-value" id="totalBookingsCount">0</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Booking hôm nay:</div>
                            <div class="detail-value" id="todayBookingsCount">0</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Nhân viên đã phân công:</div>
                            <div class="detail-value" id="assignedStaffCount">0</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Dung lượng lưu trữ:</div>
                            <div class="detail-value" id="storageSize">0 KB</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Lần lưu cuối:</div>
                            <div class="detail-value" id="lastSaved">Chưa lưu</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>ỨNG DỤNG QUẢN LÝ BOOKING & CHIA PHÒNG &copy; 2023 - QUẢN LÝ 50 NHÂN VIÊN</p>
            <p style="margin-top: 10px; font-size: 12px;">Dữ liệu được lưu tự động vào trình duyệt</p>
        </footer>
    </div>

    <script>
        // Khởi tạo dữ liệu
        let staffData = [];
        let bookings = [];
        let selectedBookingId = null;
        let bookingToDelete = null; // Biến lưu booking cần xóa
        
        // Khởi tạo dữ liệu nhân viên mặc định
        function initializeStaffData() {
            staffData = Array.from({length: 50}, (_, i) => {
                const staffNum = (i + 1).toString().padStart(3, '0');
                return {
                    id: i + 1,
                    code: `NV${staffNum}`,
                    displayName: `NHÂN VIÊN ${staffNum}`,
                    customName: `NV${staffNum}`,
                    bookingsAssigned: [],
                    roomsAssigned: [],
                    offDays: [],
                    isAvailableToday: true,
                    currentAssignments: []
                };
            });
        }
        
        // Hiển thị ngày hiện tại
        function updateTodayDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('todayDate').textContent = 
                `HÔM NAY: ${today.toLocaleDateString('vi-VN', options).toUpperCase()}`;
        }
        
        // ==================== QUẢN LÝ DỮ LIỆU - LOCALSTORAGE ====================
        
        // Lưu dữ liệu vào localStorage
        function saveDataToStorage() {
            try {
                const data = {
                    staffData: staffData,
                    bookings: bookings,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('bookingAppData', JSON.stringify(data));
                updateDataInfo();
                
                // Hiển thị thông báo thành công
                showAlert('dataAlert', 'ĐÃ LƯU DỮ LIỆU THÀNH CÔNG!', 'success');
                
                return true;
            } catch (error) {
                console.error('Lỗi khi lưu dữ liệu:', error);
                showAlert('dataAlert', 'LỖI KHI LƯU DỮ LIỆU: ' + error.message, 'danger');
                return false;
            }
        }
        
        // Tải dữ liệu từ localStorage
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('bookingAppData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    staffData = data.staffData || [];
                    bookings = data.bookings || [];
                    
                    // Đảm bảo staffData có đủ 50 nhân viên
                    if (staffData.length < 50) {
                        initializeStaffData();
                        // Cập nhật thông tin từ dữ liệu đã lưu
                        data.staffData.forEach(savedStaff => {
                            const existingStaff = staffData.find(s => s.id === savedStaff.id);
                            if (existingStaff) {
                                Object.assign(existingStaff, savedStaff);
                            }
                        });
                    }
                    
                    updateDataInfo();
                    showAlert('dataAlert', 'ĐÃ TẢI DỮ LIỆU THÀNH CÔNG!', 'success');
                    
                    // Cập nhật giao diện
                    updateAllUI();
                    
                    return true;
                } else {
                    showAlert('dataAlert', 'KHÔNG CÓ DỮ LIỆU ĐÃ LƯU!', 'warning');
                    return false;
                }
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                showAlert('dataAlert', 'LỖI KHI TẢI DỮ LIỆU: ' + error.message, 'danger');
                return false;
            }
        }
        
        // Xóa tất cả dữ liệu
        function clearAllData() {
            if (confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA TẤT CẢ DỮ LIỆU? HÀNH ĐỘNG NÀY KHÔNG THỂ HOÀN TÁC!')) {
                localStorage.removeItem('bookingAppData');
                initializeStaffData();
                bookings = [];
                selectedBookingId = null;
                
                updateDataInfo();
                updateAllUI();
                
                showAlert('dataAlert', 'ĐÃ XÓA TẤT CẢ DỮ LIỆU!', 'success');
            }
        }
        
        // Xuất dữ liệu ra file JSON
        function exportData(type = 'all') {
            let dataToExport;
            let fileName;
            
            switch(type) {
                case 'bookings':
                    dataToExport = bookings;
                    fileName = `bookings_${new Date().toISOString().slice(0, 10)}.json`;
                    break;
                case 'staff':
                    dataToExport = staffData;
                    fileName = `staff_${new Date().toISOString().slice(0, 10)}.json`;
                    break;
                default:
                    dataToExport = {
                        staffData: staffData,
                        bookings: bookings,
                        exportedAt: new Date().toISOString()
                    };
                    fileName = `booking_app_data_${new Date().toISOString().slice(0, 10)}.json`;
            }
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = fileName;
            downloadLink.click();
            
            showAlert('dataAlert', `ĐÃ XUẤT DỮ LIỆU ${type.toUpperCase()} THÀNH CÔNG!`, 'success');
        }
        
        // Nhập dữ liệu từ file
        function importDataFromFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Kiểm tra định dạng dữ liệu
                    if (importedData.bookings && importedData.staffData) {
                        // Nhập tất cả dữ liệu
                        if (confirm('BẠN CÓ MUỐN THAY THẾ TẤT CẢ DỮ LIỆU HIỆN TẠI?')) {
                            staffData = importedData.staffData;
                            bookings = importedData.bookings;
                            
                            // Đảm bảo có đủ 50 nhân viên
                            if (staffData.length < 50) {
                                const missingCount = 50 - staffData.length;
                                for (let i = 0; i < missingCount; i++) {
                                    const newId = staffData.length + 1;
                                    const staffNum = newId.toString().padStart(3, '0');
                                    staffData.push({
                                        id: newId,
                                        code: `NV${staffNum}`,
                                        displayName: `NHÂN VIÊN ${staffNum}`,
                                        customName: `NV${staffNum}`,
                                        bookingsAssigned: [],
                                        roomsAssigned: [],
                                        offDays: [],
                                        isAvailableToday: true,
                                        currentAssignments: []
                                    });
                                }
                            }
                            
                            saveDataToStorage();
                            updateAllUI();
                            showAlert('dataAlert', 'ĐÃ NHẬP DỮ LIỆU THÀNH CÔNG!', 'success');
                        }
                    } else if (Array.isArray(importedData)) {
                        // Nhập danh sách booking
                        if (confirm('BẠN CÓ MUỐN THÊM DANH SÁCH BOOKING NÀY VÀO DỮ LIỆU HIỆN TẠI?')) {
                            importedData.forEach(booking => {
                                if (!bookings.find(b => b.id === booking.id)) {
                                    bookings.push(booking);
                                }
                            });
                            
                            saveDataToStorage();
                            updateAllUI();
                            showAlert('dataAlert', 'ĐÃ NHẬP BOOKING THÀNH CÔNG!', 'success');
                        }
                    } else {
                        showAlert('dataAlert', 'ĐỊNH DẠNG FILE KHÔNG HỢP LỆ!', 'danger');
                    }
                } catch (error) {
                    showAlert('dataAlert', 'LỖI KHI ĐỌC FILE: ' + error.message, 'danger');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Cập nhật thông tin dữ liệu
        function updateDataInfo() {
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(booking => booking.date === today).length;
            
            // Đếm nhân viên đã được phân công
            let assignedStaffCount = 0;
            staffData.forEach(staff => {
                if (staff.bookingsAssigned.length > 0) {
                    assignedStaffCount++;
                }
            });
            
            // Tính dung lượng lưu trữ
            const dataSize = JSON.stringify({staffData, bookings}).length;
            const storageSize = (dataSize / 1024).toFixed(2);
            
            // Lấy thời gian lưu cuối
            const savedData = localStorage.getItem('bookingAppData');
            let lastSaved = 'Chưa lưu';
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.lastSaved) {
                        const lastSavedDate = new Date(data.lastSaved);
                        lastSaved = lastSavedDate.toLocaleString('vi-VN');
                    }
                } catch (e) {
                    // Bỏ qua lỗi
                }
            }
            
            document.getElementById('totalBookingsCount').textContent = bookings.length;
            document.getElementById('todayBookingsCount').textContent = todayBookings;
            document.getElementById('assignedStaffCount').textContent = assignedStaffCount;
            document.getElementById('storageSize').textContent = `${storageSize} KB`;
            document.getElementById('lastSaved').textContent = lastSaved;
        }
        
        // Cập nhật tất cả giao diện
        function updateAllUI() {
            updateTodayBookingsList();
            updateBookingSelect();
            updateCurrentToursList();
            updateFutureBookingsList('upcoming');
            updateStaffSelect();
            updateTodayOffStaffList();
            updateOffScheduleTable();
            updateStatistics();
        }
        
        // ==================== CHỨC NĂNG CHÍNH ====================
        
        // Chuyển đổi tab chính
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tabId).classList.add('active');
                button.classList.add('active');
                
                // Xử lý theo từng tab
                switch(tabId) {
                    case 'statistics':
                        updateStatistics();
                        break;
                    case 'room-assignment':
                        updateBookingSelect();
                        break;
                    case 'booking':
                        updateTodayBookingsList();
                        break;
                    case 'current-tours':
                        updateCurrentToursList();
                        break;
                    case 'future-bookings':
                        updateFutureBookingsList('upcoming');
                        break;
                    case 'staff-off':
                        updateStaffSelect();
                        updateTodayOffStaffList();
                        updateOffScheduleTable();
                        break;
                    case 'data-management':
                        updateDataInfo();
                        break;
                }
                
                clearAllAlerts();
            });
        });
        
        // Xóa tất cả thông báo
        function clearAllAlerts() {
            document.querySelectorAll('.alert').forEach(alert => {
                alert.style.display = 'none';
            });
        }
        
        // Chuyển đổi subtab cho booking tương lai
        document.querySelectorAll('.submenu-btn').forEach(button => {
            button.addEventListener('click', () => {
                const subtabId = button.getAttribute('data-subtab');
                
                document.querySelectorAll('.submenu-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                button.classList.add('active');
                updateFutureBookingsList(subtabId);
            });
        });
        
        // Tự động chuyển sang chữ hoa khi nhập
        document.addEventListener('DOMContentLoaded', function() {
            const uppercaseInputs = document.querySelectorAll('.uppercase');
            uppercaseInputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
                
                if (input.value) {
                    input.value = input.value.toUpperCase();
                }
            });
        });
        
        // Tab 1: Tạo booking mới
        document.getElementById('saveBookingBtn').addEventListener('click', () => {
            const tourName = document.getElementById('tourName').value.trim();
            const tourDate = document.getElementById('tourDate').value;
            const tourTime = document.getElementById('tourTime').value;
            const durationMinutes = document.getElementById('durationMinutes').value;
            const customerCount = document.getElementById('customerCount').value;
            const tourNotes = document.getElementById('tourNotes').value;
            
            if (!tourName || !tourDate || !tourTime || !durationMinutes || !customerCount) {
                showAlert('bookingAlert', 'VUI LÒNG ĐIỀN ĐẦY ĐỦ THÔNG TIN BẮT BUỘC!', 'danger');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            if (tourDate < today) {
                showAlert('bookingAlert', 'NGÀY BOOKING KHÔNG ĐƯỢC NHỎ HƠN NGÀY HÔM NAY!', 'danger');
                return;
            }
            
            // Tính thời gian kết thúc
            const startTime = new Date(`${tourDate}T${tourTime}`);
            const endTime = new Date(startTime.getTime() + parseInt(durationMinutes) * 60000);
            const endTimeString = endTime.toTimeString().slice(0, 5);
            
            // Tạo booking mới
            const booking = {
                id: Date.now(),
                name: tourName.toUpperCase(),
                date: tourDate,
                startTime: tourTime,
                endTime: endTimeString,
                durationMinutes: parseInt(durationMinutes),
                customers: parseInt(customerCount),
                notes: tourNotes.toUpperCase(),
                status: 'chua_phan_phong',
                rooms: [],
                assignedStaff: []
            };
            
            bookings.push(booking);
            showAlert('bookingAlert', `ĐÃ LƯU BOOKING "${tourName.toUpperCase()}" THÀNH CÔNG!`, 'success');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateAllUI();
        });
        
        document.getElementById('clearBookingBtn').addEventListener('click', () => {
            clearBookingForm();
            showAlert('bookingAlert', 'ĐÃ XÓA THÔNG TIN FORM!', 'warning');
        });
        
        function clearBookingForm() {
            document.getElementById('tourName').value = '';
            document.getElementById('tourDate').value = '';
            document.getElementById('tourTime').value = '';
            document.getElementById('durationMinutes').value = '';
            document.getElementById('customerCount').value = '';
            document.getElementById('tourNotes').value = '';
        }
        
        // Tab 2: Chia phòng
        
        // Cập nhật dropdown chọn booking
        function updateBookingSelect() {
            const selectBooking = document.getElementById('selectBooking');
            selectBooking.innerHTML = '<option value="">-- CHỌN BOOKING ĐỂ CHIA PHÒNG --</option>';
            
            const today = new Date().toISOString().split('T')[0];
            const availableBookings = bookings.filter(booking => 
                booking.status !== 'hoan_thanh' && booking.date >= today
            );
            
            if (availableBookings.length === 0) {
                selectBooking.innerHTML += '<option value="" disabled>KHÔNG CÓ BOOKING NÀO ĐỂ CHIA PHÒNG</option>';
                return;
            }
            
            availableBookings.forEach(booking => {
                const option = document.createElement('option');
                option.value = booking.id;
                option.textContent = `${booking.name} (${formatDate(booking.date)} ${booking.startTime}, ${booking.customers} KHÁCH)`;
                selectBooking.appendChild(option);
            });
        }
        
        // Khi chọn booking từ dropdown
        document.getElementById('selectBooking').addEventListener('change', function() {
            const bookingId = parseInt(this.value);
            selectedBookingId = bookingId;
            
            if (!bookingId) {
                document.getElementById('bookingInfoBox').style.display = 'none';
                document.getElementById('roomAssignmentSection').style.display = 'none';
                return;
            }
            
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            document.getElementById('selectedBookingName').textContent = booking.name;
            document.getElementById('selectedBookingCustomerCount').textContent = `${booking.customers} KHÁCH`;
            document.getElementById('selectedBookingDateTime').textContent = `${formatDate(booking.date)} ${booking.startTime} - ${booking.endTime}`;
            document.getElementById('selectedBookingDuration').textContent = `${booking.durationMinutes} PHÚT`;
            
            const statusBadge = document.getElementById('selectedBookingStatus');
            statusBadge.textContent = getStatusText(booking.status);
            statusBadge.className = 'badge ' + getStatusClass(booking.status);
            
            document.getElementById('selectedBookingAssignedStaff').textContent = `${booking.assignedStaff.length} NHÂN VIÊN`;
            
            document.getElementById('bookingInfoBox').style.display = 'block';
            document.getElementById('roomAssignmentSection').style.display = 'block';
            
            updateBookingRoomsList(bookingId);
            clearRoomForm();
        });
        
        // Thêm phòng vào booking
        document.getElementById('assignRoomBtn').addEventListener('click', () => {
            if (!selectedBookingId) {
                showRoomAlert('VUI LÒNG CHỌN MỘT BOOKING TRƯỚC!', 'danger');
                return;
            }
            
            const roomNumber = document.getElementById('roomNumber').value.trim().toUpperCase();
            const roomCapacity = parseInt(document.getElementById('roomCapacity').value);
            const staffInput = document.getElementById('staffCodes').value.trim();
            const booking = bookings.find(b => b.id === selectedBookingId);
            
            if (!roomNumber || !staffInput) {
                showRoomAlert('VUI LÒNG ĐIỀN ĐẦY ĐỦ THÔNG TIN PHÒNG!', 'danger');
                return;
            }
            
            const staffEntries = staffInput.split(',')
                .map(entry => entry.trim().toUpperCase())
                .filter(entry => entry);
            
            if (staffEntries.length === 0) {
                showRoomAlert('VUI LÒNG NHẬP ÍT NHẤT MỘT NHÂN VIÊN!', 'danger');
                return;
            }
            
            if (staffEntries.length > roomCapacity) {
                showRoomAlert(`SỐ NHÂN VIÊN (${staffEntries.length}) VƯỢT QUÁ SỨC CHỨA PHÒNG (${roomCapacity})!`, 'danger');
                return;
            }
            
            if (booking.rooms.some(room => room.number === roomNumber)) {
                showRoomAlert(`PHÒNG ${roomNumber} ĐÃ TỒN TẠI TRONG BOOKING NÀY!`, 'danger');
                return;
            }
            
            const assignedStaffIds = [];
            const assignedStaffNames = [];
            const invalidStaffEntries = [];
            const duplicateStaffEntries = [];
            const offStaffEntries = [];
            const scheduleConflictEntries = [];
            
            const bookingDate = booking.date;
            const bookingStartTime = booking.startTime;
            const bookingEndTime = booking.endTime;
            
            staffEntries.forEach(entry => {
                let staff = staffData.find(s => 
                    s.customName.toUpperCase() === entry || 
                    s.code === entry ||
                    s.displayName.toUpperCase().includes(entry)
                );
                
                if (!staff) {
                    staff = staffData.find(s => s.customName === s.code);
                    if (staff) {
                        staff.customName = entry;
                    } else {
                        invalidStaffEntries.push(entry);
                        return;
                    }
                }
                
                const isOffOnBookingDate = staff.offDays.some(off => off.date === bookingDate);
                if (isOffOnBookingDate) {
                    offStaffEntries.push(`${entry} (${staff.customName})`);
                    return;
                }
                
                if (booking.assignedStaff.includes(staff.id)) {
                    duplicateStaffEntries.push(`${entry} (${staff.customName})`);
                    return;
                }
                
                // KIỂM TRA TRÙNG LỊCH
                let hasScheduleConflict = false;
                let conflictDetails = '';
                
                staff.bookingsAssigned.forEach(assignedBookingId => {
                    const assignedBooking = bookings.find(b => b.id === assignedBookingId);
                    if (assignedBooking && assignedBooking.id !== booking.id) {
                        if (assignedBooking.date === bookingDate) {
                            const assignedStart = new Date(`${assignedBooking.date}T${assignedBooking.startTime}`);
                            const assignedEnd = new Date(`${assignedBooking.date}T${assignedBooking.endTime}`);
                            const newStart = new Date(`${bookingDate}T${bookingStartTime}`);
                            const newEnd = new Date(`${bookingDate}T${bookingEndTime}`);
                            
                            if ((newStart >= assignedStart && newStart < assignedEnd) ||
                                (newEnd > assignedStart && newEnd <= assignedEnd) ||
                                (newStart <= assignedStart && newEnd >= assignedEnd)) {
                                hasScheduleConflict = true;
                                conflictDetails = `TRÙNG VỚI TOUR: ${assignedBooking.name} (${assignedBooking.startTime}-${assignedBooking.endTime})`;
                            }
                        }
                    }
                });
                
                if (hasScheduleConflict) {
                    scheduleConflictEntries.push({
                        staffName: staff.customName,
                        conflictDetails: conflictDetails
                    });
                    return;
                }
                
                assignedStaffIds.push(staff.id);
                assignedStaffNames.push(staff.customName);
            });
            
            // Hiển thị cảnh báo
            let warningMessages = [];
            if (invalidStaffEntries.length > 0) {
                warningMessages.push(`KHÔNG TÌM THẤY: ${invalidStaffEntries.join(', ')}`);
            }
            if (duplicateStaffEntries.length > 0) {
                warningMessages.push(`ĐÃ PHÂN CÔNG: ${duplicateStaffEntries.join(', ')}`);
            }
            if (offStaffEntries.length > 0) {
                warningMessages.push(`OFF NGÀY ${formatDate(bookingDate)}: ${offStaffEntries.join(', ')}`);
            }
            if (scheduleConflictEntries.length > 0) {
                const conflictNames = scheduleConflictEntries.map(c => c.staffName).join(', ');
                warningMessages.push(`TRÙNG LỊCH: ${conflictNames}`);
            }
            
            if (warningMessages.length > 0) {
                let alertHTML = warningMessages.join('<br>');
                
                if (scheduleConflictEntries.length > 0) {
                    alertHTML += '<div class="schedule-conflict" style="margin-top: 10px;">';
                    alertHTML += '<strong><i class="fas fa-exclamation-triangle"></i> CHI TIẾT TRÙNG LỊCH:</strong><br>';
                    scheduleConflictEntries.forEach(conflict => {
                        alertHTML += `• ${conflict.staffName}: ${conflict.conflictDetails}<br>`;
                    });
                    alertHTML += '</div>';
                }
                
                const shouldContinue = confirm(`CÓ ${scheduleConflictEntries.length} NHÂN VIÊN BỊ TRÙNG LỊCH.\nBẠN CÓ MUỐN TIẾP TỤC PHÂN CÔNG KHÔNG?`);
                if (!shouldContinue) {
                    return;
                }
            }
            
            if (assignedStaffIds.length === 0) {
                showRoomAlert('KHÔNG CÓ NHÂN VIÊN HỢP LỆ ĐỂ PHÂN CÔNG!', 'danger');
                return;
            }
            
            const room = {
                id: Date.now(),
                number: roomNumber,
                capacity: roomCapacity,
                staffIds: assignedStaffIds,
                staffNames: assignedStaffNames,
                bookingId: selectedBookingId,
                bookingName: booking.name
            };
            
            booking.rooms.push(room);
            
            assignedStaffIds.forEach(staffId => {
                if (!booking.assignedStaff.includes(staffId)) {
                    booking.assignedStaff.push(staffId);
                }
                
                const staff = staffData.find(s => s.id === staffId);
                if (staff) {
                    if (!staff.bookingsAssigned.includes(booking.id)) {
                        staff.bookingsAssigned.push(booking.id);
                    }
                    staff.roomsAssigned.push(`${roomNumber} (${booking.name})`);
                    
                    // Cập nhật assignment hiện tại nếu tour đang diễn ra
                    const now = new Date();
                    const bookingDateTime = new Date(`${booking.date}T${booking.startTime}`);
                    const bookingEndDateTime = new Date(`${booking.date}T${booking.endTime}`);
                    
                    if (now >= bookingDateTime && now <= bookingEndDateTime) {
                        if (!staff.currentAssignments.includes(booking.id)) {
                            staff.currentAssignments.push(booking.id);
                        }
                    }
                }
            });
            
            updateBookingStatus(booking);
            
            showRoomAlert(`ĐÃ THÊM PHÒNG ${roomNumber} VỚI ${assignedStaffIds.length} NHÂN VIÊN`, 'success');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateBookingRoomsList(selectedBookingId);
            clearRoomForm();
            updateStatistics();
            updateCurrentToursList();
        });
        
        // Tự động chia phòng
        document.getElementById('autoAssignBtn').addEventListener('click', () => {
            if (!selectedBookingId) {
                showRoomAlert('VUI LÒNG CHỌN MỘT BOOKING TRƯỚC!', 'danger');
                return;
            }
            
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (!booking) return;
            
            const staffNeeded = booking.customers;
            const bookingDate = booking.date;
            const bookingStart = booking.startTime;
            const bookingEnd = booking.endTime;
            
            // Lọc nhân viên CÓ THỂ phân công
            let availableStaff = [];
            
            staffData.forEach(staff => {
                // 1. Kiểm tra nhân viên đã được phân công cho booking này chưa
                if (booking.assignedStaff.includes(staff.id)) {
                    return;
                }
                
                // 2. Kiểm tra nhân viên có OFF vào ngày này không
                const isOff = staff.offDays.some(off => off.date === bookingDate);
                if (isOff) {
                    return;
                }
                
                // 3. Kiểm tra TRÙNG LỊCH với các booking khác
                let hasScheduleConflict = false;
                
                staff.bookingsAssigned.forEach(assignedBookingId => {
                    const assignedBooking = bookings.find(b => b.id === assignedBookingId);
                    if (assignedBooking && assignedBooking.id !== booking.id) {
                        // Kiểm tra nếu cùng ngày
                        if (assignedBooking.date === bookingDate) {
                            const assignedStart = new Date(`${assignedBooking.date}T${assignedBooking.startTime}`);
                            const assignedEnd = new Date(`${assignedBooking.date}T${assignedBooking.endTime}`);
                            const newStart = new Date(`${bookingDate}T${bookingStart}`);
                            const newEnd = new Date(`${bookingDate}T${bookingEnd}`);
                            
                            // Kiểm tra khoảng thời gian có trùng nhau không
                            if ((newStart >= assignedStart && newStart < assignedEnd) ||
                                (newEnd > assignedStart && newEnd <= assignedEnd) ||
                                (newStart <= assignedStart && newEnd >= assignedEnd)) {
                                hasScheduleConflict = true;
                            }
                        }
                    }
                });
                
                if (hasScheduleConflict) {
                    return;
                }
                
                // 4. Tính số lượng booking nhân viên đã có trong ngày
                const bookingsCountToday = staff.bookingsAssigned.filter(bookingId => {
                    const b = bookings.find(book => book.id === bookingId);
                    return b && b.date === bookingDate;
                }).length;
                
                // Nhân viên hợp lệ
                availableStaff.push({
                    ...staff,
                    bookingsCountToday: bookingsCountToday
                });
            });
            
            // Sắp xếp ưu tiên nhân viên có ÍT booking trong ngày nhất
            availableStaff.sort((a, b) => a.bookingsCountToday - b.bookingsCountToday);
            
            if (availableStaff.length < staffNeeded) {
                showRoomAlert(`KHÔNG ĐỦ NHÂN VIÊN! CẦN ${staffNeeded}, CHỈ CÓ ${availableStaff.length} NHÂN VIÊN CÓ SẴN.`, 'warning');
                
                // Vẫn chia số nhân viên có sẵn
                if (availableStaff.length === 0) {
                    showRoomAlert('KHÔNG CÓ NHÂN VIÊN NÀO CÓ THỂ PHÂN CÔNG!', 'danger');
                    return;
                }
            }
            
            // Chia thành các phòng (mỗi phòng tối đa 5 người)
            const roomCapacity = 5;
            let roomCounter = booking.rooms.length + 1;
            let assignedCount = 0;
            let roomsAdded = 0;
            
            for (let i = 0; i < Math.min(availableStaff.length, staffNeeded); i += roomCapacity) {
                const roomStaff = availableStaff.slice(i, Math.min(i + roomCapacity, staffNeeded));
                const staffIds = roomStaff.map(staff => staff.id);
                const staffNames = roomStaff.map(staff => staff.customName);
                
                const room = {
                    id: Date.now() + i,
                    number: `P${(roomCounter).toString().padStart(3, '0')}`,
                    capacity: roomCapacity,
                    staffIds: staffIds,
                    staffNames: staffNames,
                    bookingId: selectedBookingId,
                    bookingName: booking.name
                };
                
                booking.rooms.push(room);
                
                staffIds.forEach(staffId => {
                    if (!booking.assignedStaff.includes(staffId)) {
                        booking.assignedStaff.push(staffId);
                        assignedCount++;
                    }
                    
                    const staff = staffData.find(s => s.id === staffId);
                    if (staff) {
                        if (!staff.bookingsAssigned.includes(booking.id)) {
                            staff.bookingsAssigned.push(booking.id);
                        }
                        staff.roomsAssigned.push(`${room.number} (${booking.name})`);
                    }
                });
                
                roomCounter++;
                roomsAdded++;
            }
            
            updateBookingStatus(booking);
            
            let alertMessage = `ĐÃ TỰ ĐỘNG CHIA ${assignedCount} NHÂN VIÊN VÀO ${roomsAdded} PHÒNG`;
            
            if (assignedCount < staffNeeded) {
                alertMessage += ` (THIẾU ${staffNeeded - assignedCount} NHÂN VIÊN)`;
            }
            
            showRoomAlert(alertMessage, assignedCount >= staffNeeded ? 'success' : 'warning');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateBookingRoomsList(selectedBookingId);
            clearRoomForm();
            updateStatistics();
            updateCurrentToursList();
        });
        
        // Đánh dấu hoàn thành booking
        document.getElementById('markCompleteBtn').addEventListener('click', () => {
            if (!selectedBookingId) {
                showRoomAlert('VUI LÒNG CHỌN MỘT BOOKING TRƯỚC!', 'danger');
                return;
            }
            
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (!booking) return;
            
            if (booking.assignedStaff.length < booking.customers) {
                if (!confirm(`BOOKING NÀY MỚI PHÂN CÔNG ĐƯỢC ${booking.assignedStaff.length}/${booking.customers} NHÂN VIÊN. BẠN VẪN MUỐN ĐÁNH DẤU HOÀN THÀNH?`)) {
                    return;
                }
            }
            
            booking.status = 'hoan_thanh';
            
            // Xóa assignment hiện tại của nhân viên
            booking.assignedStaff.forEach(staffId => {
                const staff = staffData.find(s => s.id === staffId);
                if (staff) {
                    const index = staff.currentAssignments.indexOf(booking.id);
                    if (index !== -1) {
                        staff.currentAssignments.splice(index, 1);
                    }
                }
            });
            
            showRoomAlert(`ĐÃ ĐÁNH DẤU BOOKING "${booking.name}" HOÀN THÀNH!`, 'success');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateBookingRoomsList(selectedBookingId);
            updateBookingSelect();
            updateFutureBookingsList('upcoming');
            updateCurrentToursList();
            updateStatistics();
        });
        
        document.getElementById('clearRoomFormBtn').addEventListener('click', clearRoomForm);
        
        function clearRoomForm() {
            document.getElementById('roomNumber').value = '';
            document.getElementById('staffCodes').value = '';
            document.getElementById('duplicateWarning').style.display = 'none';
        }
        
        // Kiểm tra trùng lặp khi nhập mã nhân viên
        document.getElementById('staffCodes').addEventListener('input', function() {
            if (!selectedBookingId) return;
            
            const staffInput = this.value.trim();
            if (!staffInput) {
                document.getElementById('duplicateWarning').style.display = 'none';
                return;
            }
            
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (!booking) return;
            
            const staffEntries = staffInput.split(',')
                .map(entry => entry.trim().toUpperCase())
                .filter(entry => entry);
            
            const duplicates = [];
            
            staffEntries.forEach(entry => {
                const staff = staffData.find(s => 
                    s.customName.toUpperCase() === entry || 
                    s.code === entry ||
                    s.displayName.toUpperCase().includes(entry)
                );
                
                if (staff && booking.assignedStaff.includes(staff.id)) {
                    duplicates.push(entry);
                }
            });
            
            if (duplicates.length > 0) {
                document.getElementById('duplicateWarning').style.display = 'block';
                document.getElementById('duplicateWarning').innerHTML = 
                    `<i class="fas fa-exclamation-triangle"></i> CẢNH BÁO: ${duplicates.length} NHÂN VIÊN ĐÃ ĐƯỢC PHÂN CÔNG (${duplicates.join(', ')})!`;
            } else {
                document.getElementById('duplicateWarning').style.display = 'none';
            }
        });
        
        // Cập nhật danh sách phòng của booking
        function updateBookingRoomsList(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            const roomsList = document.getElementById('bookingRoomsList');
            roomsList.innerHTML = '';
            
            if (booking.rooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #7f8c8d;">
                        <i class="fas fa-door-closed fa-3x" style="margin-bottom: 15px; opacity: 0.5;"></i>
                        <h4>CHƯA CÓ PHÒNG NÀO ĐƯỢC PHÂN CÔNG</h4>
                        <p>HÃY THÊM PHÒNG ĐẦU TIÊN BẰNG FORM BÊN TRÊN</p>
                    </div>
                `;
                return;
            }
            
            booking.rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-card';
                
                let staffListHTML = '';
                room.staffNames.forEach(name => {
                    staffListHTML += `
                        <li>
                            ${name}
                        </li>
                    `;
                });
                
                roomElement.innerHTML = `
                    <div class="room-header">
                        <div class="room-title">PHÒNG ${room.number}</div>
                        <div class="room-capacity">${room.staffNames.length}/${room.capacity} NGƯỜI</div>
                    </div>
                    <div><strong><i class="fas fa-id-badge"></i> NHÂN VIÊN:</strong></div>
                    <ul class="staff-list">
                        ${staffListHTML || '<li style="text-align: center; color: #7f8c8d;">CHƯA CÓ NHÂN VIÊN</li>'}
                    </ul>
                    <div class="room-actions">
                        <button class="btn-remove-room" onclick="removeRoom(${bookingId}, ${room.id})">
                            <i class="fas fa-trash"></i> XÓA PHÒNG
                        </button>
                    </div>
                `;
                
                roomsList.appendChild(roomElement);
            });
        }
        
        // Hàm xóa phòng
        window.removeRoom = function(bookingId, roomId) {
            if (!confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA PHÒNG NÀY?')) {
                return;
            }
            
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            const roomIndex = booking.rooms.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            const room = booking.rooms[roomIndex];
            
            room.staffIds.forEach(staffId => {
                const staffIndex = booking.assignedStaff.indexOf(staffId);
                if (staffIndex !== -1) {
                    booking.assignedStaff.splice(staffIndex, 1);
                }
                
                const staff = staffData.find(s => s.id === staffId);
                if (staff) {
                    const bookingIndex = staff.bookingsAssigned.indexOf(bookingId);
                    if (bookingIndex !== -1) {
                        staff.bookingsAssigned.splice(bookingIndex, 1);
                    }
                    
                    const roomAssignment = `${room.number} (${booking.name})`;
                    const roomIndex = staff.roomsAssigned.indexOf(roomAssignment);
                    if (roomIndex !== -1) {
                        staff.roomsAssigned.splice(roomIndex, 1);
                    }
                    
                    const currentAssignmentIndex = staff.currentAssignments.indexOf(bookingId);
                    if (currentAssignmentIndex !== -1) {
                        staff.currentAssignments.splice(currentAssignmentIndex, 1);
                    }
                }
            });
            
            booking.rooms.splice(roomIndex, 1);
            
            updateBookingStatus(booking);
            
            showRoomAlert(`ĐÃ XÓA PHÒNG ${room.number}`, 'warning');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateBookingRoomsList(bookingId);
            updateCurrentToursList();
            updateStatistics();
        };
        
        // Tab 3: TOUR ĐANG DIỄN RA
        document.getElementById('refreshCurrentToursBtn').addEventListener('click', updateCurrentToursList);
        document.getElementById('showAllCurrentToursBtn').addEventListener('click', () => {
            document.getElementById('filterCurrentDate').value = '';
            document.getElementById('filterCurrentTime').value = '';
            updateCurrentToursList();
        });
        document.getElementById('showNowToursBtn').addEventListener('click', () => {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().slice(0, 5);
            
            document.getElementById('filterCurrentDate').value = today;
            document.getElementById('filterCurrentTime').value = currentTime;
            updateCurrentToursList();
        });
        
        // Hàm cập nhật danh sách tour đang diễn ra
        function updateCurrentToursList() {
            const currentToursList = document.getElementById('currentToursList');
            
            // Xóa phần hiển thị nhân viên đang làm việc
            document.getElementById('currentStaffList').innerHTML = '';
            
            currentToursList.innerHTML = '';
            
            const filterDate = document.getElementById('filterCurrentDate').value;
            const filterTime = document.getElementById('filterCurrentTime').value;
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            let currentTours = [];
            
            // Lọc tour đang diễn ra
            bookings.forEach(booking => {
                const bookingDate = booking.date;
                const bookingStart = new Date(`${bookingDate}T${booking.startTime}`);
                const bookingEnd = new Date(`${bookingDate}T${booking.endTime}`);
                
                let isCurrent = false;
                
                if (filterDate && filterTime) {
                    // Có cả ngày và giờ lọc
                    const filterDateTime = new Date(`${filterDate}T${filterTime}`);
                    isCurrent = (filterDateTime >= bookingStart && filterDateTime <= bookingEnd);
                } else if (filterDate && !filterTime) {
                    // Chỉ có ngày lọc
                    isCurrent = (bookingDate === filterDate);
                } else if (!filterDate && filterTime) {
                    // Chỉ có giờ lọc
                    const bookingStartTime = booking.startTime;
                    const bookingEndTime = booking.endTime;
                    isCurrent = (filterTime >= bookingStartTime && filterTime <= bookingEndTime && bookingDate >= today);
                } else {
                    // Không có bộ lọc - lấy tour đang diễn ra NGAY BÂY GIỜ
                    isCurrent = (now >= bookingStart && now <= bookingEnd);
                }
                
                if (isCurrent && booking.status !== 'hoan_thanh') {
                    currentTours.push(booking);
                }
            });
            
            // HIỂN THỊ DANH SÁCH TOUR
            if (currentTours.length === 0) {
                currentToursList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>KHÔNG CÓ TOUR NÀO ĐANG DIỄN RA</h3>
                        <p>${filterDate ? `KHÔNG CÓ TOUR VÀO ${formatDate(filterDate)} ${filterTime ? 'LÚC ' + filterTime : ''}` : 'KHÔNG CÓ TOUR ĐANG HOẠT ĐỘNG'}</p>
                        <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                            Tổng booking: ${bookings.length} | Booking hôm nay: ${bookings.filter(b => b.date === today).length}
                        </p>
                    </div>
                `;
            } else {
                // Sắp xếp theo thời gian bắt đầu
                currentTours.sort((a, b) => {
                    const aTime = new Date(`${a.date}T${a.startTime}`);
                    const bTime = new Date(`${b.date}T${b.startTime}`);
                    return aTime - bTime;
                });
                
                currentTours.forEach(booking => {
                    const bookingElement = document.createElement('div');
                    bookingElement.className = 'current-tour-card';
                    
                    const bookingStart = new Date(`${booking.date}T${booking.startTime}`);
                    const bookingEnd = new Date(`${booking.date}T${booking.endTime}`);
                    
                    // Tính thời gian còn lại
                    let timeStatus = '';
                    let timeColor = '';
                    let statusIcon = '';
                    
                    if (now >= bookingStart && now <= bookingEnd) {
                        const timeRemaining = Math.round((bookingEnd - now) / 60000);
                        timeStatus = `ĐANG DIỄN RA - Còn ${timeRemaining} phút`;
                        timeColor = '#4CAF50';
                        statusIcon = '🟢';
                    } else if (now < bookingStart) {
                        const minutesUntilStart = Math.round((bookingStart - now) / 60000);
                        timeStatus = `SẮP BẮT ĐẦU - Còn ${minutesUntilStart} phút`;
                        timeColor = '#FF9800';
                        statusIcon = '🟡';
                    } else {
                        timeStatus = `ĐÃ KẾT THÚC`;
                        timeColor = '#9E9E9E';
                        statusIcon = '🔴';
                    }
                    
                    // HIỂN THỊ THÔNG TIN TOUR VÀ PHÒNG
                    let roomsHTML = '';
                    
                    if (booking.rooms.length === 0) {
                        roomsHTML = `
                            <div style="background-color: #fff8e1; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ff9800;">
                                <i class="fas fa-exclamation-triangle"></i> CHƯA PHÂN PHÒNG
                            </div>
                        `;
                    } else {
                        // HIỂN THỊ TỪNG PHÒNG VÀ NHÂN VIÊN TRONG PHÒNG
                        booking.rooms.forEach(room => {
                            let staffListHTML = '';
                            
                            if (room.staffNames && room.staffNames.length > 0) {
                                staffListHTML = room.staffNames.map(staffName => 
                                    `<div style="margin: 3px 0; padding: 3px 8px; background-color: #e3f2fd; border-radius: 3px; display: inline-block; margin-right: 5px; font-size: 13px;">
                                        ${staffName}
                                    </div>`
                                ).join('');
                            } else {
                                staffListHTML = '<div style="color: #999; font-style: italic; font-size: 13px;">Chưa có nhân viên</div>';
                            }
                            
                            roomsHTML += `
                                <div class="room-card" style="margin-bottom: 15px; padding: 12px; background-color: white; border-radius: 5px; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center;">
                                            <i class="fas fa-door-closed" style="color: #795548; margin-right: 8px;"></i>
                                            <strong style="color: #2196F3; font-size: 15px;">PHÒNG ${room.number}</strong>
                                        </div>
                                        <span style="background-color: #4CAF50; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                            ${room.staffNames ? room.staffNames.length : 0}/${room.capacity} NV
                                        </span>
                                    </div>
                                    <div>
                                        <div style="font-size: 13px; margin-bottom: 5px; color: #666;"><strong>Nhân viên trong phòng:</strong></div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">${staffListHTML}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    // Đếm tổng số nhân viên đã phân
                    let totalAssignedStaff = 0;
                    booking.rooms.forEach(room => {
                        totalAssignedStaff += (room.staffNames ? room.staffNames.length : 0);
                    });
                    
                    bookingElement.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 18px;">${booking.name}</h4>
                                    <div style="display: flex; align-items: center; gap: 10px; font-size: 14px; color: #666;">
                                        <span><i class="fas fa-calendar-day"></i> ${formatDate(booking.date)}</span>
                                        <span><i class="fas fa-clock"></i> ${booking.startTime} - ${booking.endTime}</span>
                                        <span style="color: ${timeColor}; font-weight: bold;">${statusIcon} ${timeStatus}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="background-color: #f0f7ff; padding: 5px 12px; border-radius: 20px; font-weight: bold; color: #1565C0;">
                                        ${booking.customers} KHÁCH
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background-color: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                                    <div>
                                        <div style="color: #666; font-size: 12px;">THỜI LƯỢNG</div>
                                        <div style="font-weight: bold;">${booking.durationMinutes} phút</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 12px;">TỔNG PHÒNG</div>
                                        <div style="font-weight: bold;">${booking.rooms.length} phòng</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 12px;">NV ĐÃ PHÂN</div>
                                        <div style="font-weight: bold;">${totalAssignedStaff}/${booking.customers} NV</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 12px;">TRẠNG THÁI</div>
                                        <div><span class="badge ${getStatusClass(booking.status)}">${getStatusText(booking.status)}</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0 15px 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center;">
                                        <i class="fas fa-hotel" style="color: #795548; margin-right: 8px; font-size: 16px;"></i>
                                        <h5 style="margin: 0; color: #333; font-size: 16px;">DANH SÁCH PHÒNG</h5>
                                    </div>
                                    <span style="background-color: #e3f2fd; color: #1565C0; padding: 3px 12px; border-radius: 15px; font-size: 13px; font-weight: bold;">
                                        ${booking.rooms.length} PHÒNG
                                    </span>
                                </div>
                                
                                ${roomsHTML}
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 13px; color: #666;">
                                    <i class="fas fa-sticky-note"></i> ${booking.notes || 'Không có ghi chú'}
                                </div>
                                <div>
                                    <button class="btn" onclick="selectBookingForAssignment(${booking.id})" style="padding: 8px 16px; font-size: 14px; margin-right: 5px;">
                                        <i class="fas fa-door-open"></i> CHIA PHÒNG
                                    </button>
                                    <button class="btn btn-delete-sm" onclick="showDeleteBookingModal(${booking.id})" style="padding: 8px 16px; font-size: 14px; background-color: #e74c3c;">
                                        <i class="fas fa-trash"></i> XÓA
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    currentToursList.appendChild(bookingElement);
                });
            }
        }
        
        // Tab 4: Booking tương lai
        function updateFutureBookingsList(filterType = 'upcoming') {
            const futureBookingsList = document.getElementById('futureBookingsList');
            futureBookingsList.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            let filteredBookings = [];
            
            switch(filterType) {
                case 'upcoming':
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = tomorrow.toISOString().split('T')[0];
                    filteredBookings = bookings.filter(booking => booking.date >= tomorrowStr);
                    break;
                    
                case 'this-week':
                    const startOfWeek = getStartOfWeek();
                    const endOfWeek = getEndOfWeek();
                    filteredBookings = bookings.filter(booking => 
                        booking.date >= startOfWeek && booking.date <= endOfWeek
                    );
                    break;
                    
                case 'next-week':
                    const startOfNextWeek = getStartOfNextWeek();
                    const endOfNextWeek = getEndOfNextWeek();
                    filteredBookings = bookings.filter(booking => 
                        booking.date >= startOfNextWeek && booking.date <= endOfNextWeek
                    );
                    break;
                    
                case 'all-future':
                    filteredBookings = bookings.filter(booking => booking.date > today);
                    break;
            }
            
            const filterDate = document.getElementById('filterDate').value;
            if (filterDate) {
                filteredBookings = filteredBookings.filter(booking => booking.date === filterDate);
            }
            
            const filterStatus = document.getElementById('filterStatus').value;
            if (filterStatus !== 'all') {
                filteredBookings = filteredBookings.filter(booking => booking.status === filterStatus);
            }
            
            filteredBookings.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (filteredBookings.length === 0) {
                futureBookingsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>KHÔNG CÓ BOOKING NÀO</h3>
                        <p>HÃY TẠO BOOKING MỚI TRONG TAB NHẬN BOOKING</p>
                    </div>
                `;
                return;
            }
            
            filteredBookings.forEach(booking => {
                const bookingElement = document.createElement('div');
                bookingElement.className = 'booking-card';
                
                let dateClass = 'booking-status-future';
                if (booking.date === today) {
                    dateClass = 'booking-status-today';
                } else if (booking.date < today) {
                    dateClass = 'booking-status-past';
                }
                bookingElement.classList.add(dateClass);
                
                // Thêm nút xóa booking
                const deleteButton = `
                    <button class="btn-delete-booking" onclick="showDeleteBookingModal(${booking.id})">
                        <i class="fas fa-trash"></i> XÓA
                    </button>
                `;
                
                bookingElement.innerHTML = `
    <div class="booking-header">
        <div class="booking-title">${booking.name}</div>
        <div class="booking-customer-count">${booking.customers} KHÁCH</div>
    </div>
    <div class="booking-details">
        <!-- ... các detail rows ... -->
    </div>
    <div style="margin-top: 15px;">
        <button class="btn btn-secondary" onclick="selectBookingForAssignment(${booking.id})" style="width: 100%; margin-bottom: 5px;">
            <i class="fas fa-door-open"></i> CHIA PHÒNG CHO BOOKING NÀY
        </button>
        <button class="btn-delete-booking" onclick="showDeleteBookingModal(${booking.id})" style="width: 100%;">
            <i class="fas fa-trash"></i> XÓA BOOKING
        </button>
    </div>
`;
                
                futureBookingsList.appendChild(bookingElement);
            });
        }
        
        // Áp dụng bộ lọc cho booking tương lai
        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            const activeSubTab = document.querySelector('.submenu-btn.active');
            if (activeSubTab) {
                const subtabId = activeSubTab.getAttribute('data-subtab');
                updateFutureBookingsList(subtabId);
            }
        });
        
        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterStatus').value = 'all';
            const activeSubTab = document.querySelector('.submenu-btn.active');
            if (activeSubTab) {
                const subtabId = activeSubTab.getAttribute('data-subtab');
                updateFutureBookingsList(subtabId);
            }
        });
        
        // Tab 5: Quản lý nhân viên off
        function updateStaffSelect() {
            const staffSelect = document.getElementById('staffSelect');
            staffSelect.innerHTML = '<option value="">-- CHỌN NHÂN VIÊN --</option>';
            
            staffData.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = `${staff.customName} - ${staff.displayName}`;
                staffSelect.appendChild(option);
            });
        }
        
        // Đánh dấu nhân viên off
        document.getElementById('markOffBtn').addEventListener('click', () => {
            const staffId = parseInt(document.getElementById('staffSelect').value);
            const offDate = document.getElementById('offDate').value;
            const offReason = document.getElementById('offReason').value.trim();
            
            if (!staffId || !offDate) {
                showAlert('staffOffAlert', 'VUI LÒNG CHỌN NHÂN VIÊN VÀ NGÀY OFF!', 'danger');
                return;
            }
            
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            const alreadyOff = staff.offDays.some(off => off.date === offDate);
            if (alreadyOff) {
                showAlert('staffOffAlert', `NHÂN VIÊN ${staff.customName} ĐÃ OFF VÀO NGÀY ${formatDate(offDate)}!`, 'warning');
                return;
            }
            
            staff.offDays.push({
                date: offDate,
                reason: offReason.toUpperCase() || 'KHÔNG CÓ LÝ DO'
            });
            
            const today = new Date().toISOString().split('T')[0];
            if (offDate === today) {
                staff.isAvailableToday = false;
            }
            
            showAlert('staffOffAlert', `ĐÃ ĐÁNH DẤU NHÂN VIÊN ${staff.customName} OFF VÀO NGÀY ${formatDate(offDate)}`, 'success');
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateTodayOffStaffList();
            updateOffScheduleTable();
            updateStatistics();
            clearOffForm();
        });
        
        // Đánh dấu nhân viên có mặt
        document.getElementById('markAvailableBtn').addEventListener('click', () => {
            const staffId = parseInt(document.getElementById('staffSelect').value);
            const offDate = document.getElementById('offDate').value;
            
            if (!staffId || !offDate) {
                showAlert('staffOffAlert', 'VUI LÒNG CHỌN NHÂN VIÊN VÀ NGÀY!', 'danger');
                return;
            }
            
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            const offIndex = staff.offDays.findIndex(off => off.date === offDate);
            if (offIndex !== -1) {
                staff.offDays.splice(offIndex, 1);
                
                const today = new Date().toISOString().split('T')[0];
                if (offDate === today) {
                    staff.isAvailableToday = true;
                }
                
                showAlert('staffOffAlert', `ĐÃ XÓA OFF CHO NHÂN VIÊN ${staff.customName} VÀO NGÀY ${formatDate(offDate)}`, 'success');
            } else {
                showAlert('staffOffAlert', `NHÂN VIÊN ${staff.customName} KHÔNG OFF VÀO NGÀY ${formatDate(offDate)}`, 'warning');
            }
            
            // Lưu dữ liệu
            saveDataToStorage();
            
            updateTodayOffStaffList();
            updateOffScheduleTable();
            updateStatistics();
            clearOffForm();
        });
        
        document.getElementById('clearOffFormBtn').addEventListener('click', clearOffForm);
        
        function clearOffForm() {
            document.getElementById('staffSelect').value = '';
            document.getElementById('offDate').value = '';
            document.getElementById('offReason').value = '';
        }
        
        // Cập nhật danh sách nhân viên off hôm nay
        function updateTodayOffStaffList() {
            const todayOffStaffList = document.getElementById('todayOffStaffList');
            todayOffStaffList.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const offStaffToday = staffData.filter(staff => 
                staff.offDays.some(off => off.date === today)
            );
            
            if (offStaffToday.length === 0) {
                todayOffStaffList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-check"></i>
                        <h3>KHÔNG CÓ NHÂN VIÊN NÀO OFF HÔM NAY</h3>
                        <p>TẤT CẢ NHÂN VIÊN ĐỀU CÓ MẶT</p>
                    </div>
                `;
                return;
            }
            
            offStaffToday.forEach(staff => {
                const offDay = staff.offDays.find(off => off.date === today);
                
                const staffItem = document.createElement('div');
                staffItem.className = 'staff-off-item';
                
                staffItem.innerHTML = `
                    <div class="staff-off-info">
                        <div class="staff-avatar">${staff.id.toString().padStart(2, '0')}</div>
                        <div>
                            <div><strong>${staff.customName}</strong> - ${staff.displayName}</div>
                            <div style="color: #e74c3c; font-size: 14px; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> LÝ DO: ${offDay.reason}
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeOffDay(${staff.id}, '${today}')">
                        <i class="fas fa-user-check"></i> XÓA OFF
                    </button>
                `;
                
                todayOffStaffList.appendChild(staffItem);
            });
        }
        
        // Cập nhật bảng lịch off
        function updateOffScheduleTable() {
            const offScheduleBody = document.getElementById('offScheduleBody');
            offScheduleBody.innerHTML = '';
            
            const filterDate = document.getElementById('offFilterDate').value;
            const filterStaff = document.getElementById('offFilterStaff').value.trim().toUpperCase();
            
            let allOffDays = [];
            staffData.forEach(staff => {
                staff.offDays.forEach(offDay => {
                    allOffDays.push({
                        staffId: staff.id,
                        staffName: staff.displayName,
                        customName: staff.customName,
                        date: offDay.date,
                        reason: offDay.reason
                    });
                });
            });
            
            if (filterDate) {
                allOffDays = allOffDays.filter(off => off.date === filterDate);
            }
            
            if (filterStaff) {
                allOffDays = allOffDays.filter(off => 
                    off.customName.toUpperCase().includes(filterStaff) || 
                    off.staffName.toUpperCase().includes(filterStaff)
                );
            }
            
            allOffDays.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (allOffDays.length === 0) {
                offScheduleBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #7f8c8d;">
                            <i class="fas fa-calendar-check"></i> KHÔNG CÓ LỊCH OFF NÀO
                        </td>
                    </tr>
                `;
                return;
            }
            
            allOffDays.forEach(off => {
                const today = new Date().toISOString().split('T')[0];
                let status = '';
                if (off.date < today) {
                    status = `<span class="badge" style="background-color: #95a5a6; color: white;">ĐÃ QUA</span>`;
                } else if (off.date === today) {
                    status = `<span class="badge badge-danger">HÔM NAY</span>`;
                } else {
                    status = `<span class="badge badge-warning">SẮP TỚI</span>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${off.customName}</strong> - ${off.staffName}</td>
                    <td>${formatDate(off.date)} (${getDayOfWeek(off.date)})</td>
                    <td>${off.reason}</td>
                    <td>${status}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeOffDay(${off.staffId}, '${off.date}')">
                            <i class="fas fa-trash"></i> XÓA
                        </button>
                    </td>
                `;
                offScheduleBody.appendChild(row);
            });
        }
        
        // Hàm xóa off day
        window.removeOffDay = function(staffId, date) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            const offIndex = staff.offDays.findIndex(off => off.date === date);
            if (offIndex !== -1) {
                staff.offDays.splice(offIndex, 1);
                
                const today = new Date().toISOString().split('T')[0];
                if (date === today) {
                    staff.isAvailableToday = true;
                }
                
                showAlert('staffOffAlert', `ĐÃ XÓA OFF CHO NHÂN VIÊN ${staff.customName} VÀO NGÀY ${formatDate(date)}`, 'success');
                
                // Lưu dữ liệu
                saveDataToStorage();
                
                updateTodayOffStaffList();
                updateOffScheduleTable();
                updateStatistics();
            }
        };
        
        // Áp dụng bộ lọc cho lịch off
        document.getElementById('applyOffFilterBtn').addEventListener('click', updateOffScheduleTable);
        document.getElementById('resetOffFilterBtn').addEventListener('click', () => {
            document.getElementById('offFilterDate').value = '';
            document.getElementById('offFilterStaff').value = '';
            updateOffScheduleTable();
        });
        
        // Tab 6: Thống kê
        document.getElementById('refreshStatsBtn').addEventListener('click', updateStatistics);
        
        document.getElementById('exportStatsBtn').addEventListener('click', () => {
            alert('CHỨC NĂNG XUẤT THỐNG KÊ ĐANG ĐƯỢC PHÁT TRIỂN!');
        });
        
        // Hàm cập nhật thống kê
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            
            const todayBookings = bookings.filter(booking => booking.date === today);
            const futureBookings = bookings.filter(booking => booking.date > today);
            
            const offStaffToday = staffData.filter(staff => 
                staff.offDays.some(off => off.date === today)
            ).length;
            
            document.getElementById('totalBookingsToday').textContent = todayBookings.length;
            document.getElementById('futureBookingsCount').textContent = futureBookings.length;
            document.getElementById('offStaffToday').textContent = offStaffToday;
            
            updateStaffStatsTable();
        }
        
        // Cập nhật bảng thống kê nhân viên
        function updateStaffStatsTable() {
            const statDate = document.getElementById('statDate').value;
            const staffFilter = document.getElementById('statStaffCode').value.trim().toUpperCase();
            
            const statsTableBody = document.getElementById('statsTableBody');
            statsTableBody.innerHTML = '';
            
            let filteredStaff = staffData;
            if (staffFilter) {
                filteredStaff = staffData.filter(staff => 
                    staff.customName.toUpperCase().includes(staffFilter) || 
                    staff.displayName.toUpperCase().includes(staffFilter)
                );
            }
            
            filteredStaff.sort((a, b) => b.bookingsAssigned.length - a.bookingsAssigned.length);
            
            if (filteredStaff.length === 0) {
                statsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #7f8c8d;">
                            <i class="fas fa-user-slash fa-2x" style="margin-bottom: 10px;"></i><br>
                            KHÔNG TÌM THẤY NHÂN VIÊN PHÙ HỢP
                        </td>
                    </tr>
                `;
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = statDate || today;
            
            filteredStaff.forEach(staff => {
                let bookingCount = 0;
                if (selectedDate) {
                    bookingCount = staff.bookingsAssigned.filter(bookingId => {
                        const booking = bookings.find(b => b.id === bookingId);
                        return booking && booking.date === selectedDate;
                    }).length;
                }
                
                const isOff = staff.offDays.some(off => off.date === selectedDate);
                
                let status = '';
                if (isOff) {
                    const offDay = staff.offDays.find(off => off.date === selectedDate);
                    status = `<span class="badge badge-danger">OFF (${offDay.reason})</span>`;
                } else if (bookingCount > 0) {
                    status = `<span class="badge badge-success">ĐANG LÀM VIỆC (${bookingCount} BOOKING)</span>`;
                } else {
                    status = `<span class="badge badge-info">RẢNH</span>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${staff.customName}</strong></td>
                    <td>${staff.displayName}</td>
                    <td><strong>${bookingCount}</strong> BOOKING</td>
                    <td>${staff.roomsAssigned.length > 0 ? staff.roomsAssigned.slice(0, 2).join(', ') : 'CHƯA PHÂN CÔNG'}${staff.roomsAssigned.length > 2 ? '...' : ''}</td>
                    <td>${status}</td>
                `;
                statsTableBody.appendChild(row);
            });
        }
        
        // Tab 7: Quản lý dữ liệu
        document.getElementById('saveDataBtn').addEventListener('click', () => {
            saveDataToStorage();
        });
        
        document.getElementById('loadDataBtn').addEventListener('click', () => {
            loadDataFromStorage();
        });
        
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        
        document.getElementById('exportAllDataBtn').addEventListener('click', () => exportData('all'));
        document.getElementById('exportBookingsBtn').addEventListener('click', () => exportData('bookings'));
        document.getElementById('exportStaffBtn').addEventListener('click', () => exportData('staff'));
        
        document.getElementById('importDataBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('importFile');
            if (fileInput.files.length > 0) {
                importDataFromFile(fileInput.files[0]);
            } else {
                showAlert('dataAlert', 'VUI LÒNG CHỌN FILE TRƯỚC KHI NHẬP!', 'warning');
            }
        });
        
        // ==================== CHỨC NĂNG XÓA BOOKING ====================
        
        // Hàm hiển thị modal xóa booking
        window.showDeleteBookingModal = function(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            bookingToDelete = bookingId;
            
            const modal = document.getElementById('deleteBookingModal');
            const message = document.getElementById('deleteBookingMessage');
            
            // Kiểm tra xem booking đã được phân phòng chưa
            let warningMessage = '';
            if (booking.rooms.length > 0) {
                warningMessage = '<div style="color: #e74c3c; margin-top: 10px; padding: 10px; background-color: #ffebee; border-radius: 5px;">';
                warningMessage += '<i class="fas fa-exclamation-triangle"></i> <strong>CẢNH BÁO:</strong> Booking này đã được phân vào ' + booking.rooms.length + ' phòng. Xóa booking sẽ xóa tất cả phân công phòng liên quan!';
                warningMessage += '</div>';
            }
            
            message.innerHTML = `
                Bạn có chắc chắn muốn xóa booking <strong>"${booking.name}"</strong>?<br><br>
                <strong>Thông tin booking:</strong><br>
                • Ngày: ${formatDate(booking.date)}<br>
                • Giờ: ${booking.startTime} - ${booking.endTime}<br>
                • Khách: ${booking.customers} người<br>
                • Trạng thái: ${getStatusText(booking.status)}<br>
                • Phòng đã phân: ${booking.rooms.length} phòng<br><br>
                ${warningMessage}
                <strong style="color: #c0392b;">HÀNH ĐỘNG NÀY KHÔNG THỂ HOÀN TÁC!</strong>
            `;
            
            modal.style.display = 'flex';
        };
        
        // Xử lý xác nhận xóa booking
        document.getElementById('confirmDeleteBookingBtn').addEventListener('click', function() {
            if (!bookingToDelete) return;
            
            deleteBooking(bookingToDelete);
            hideDeleteBookingModal();
        });
        
        // Hủy xóa booking
        document.getElementById('cancelDeleteBookingBtn').addEventListener('click', hideDeleteBookingModal);
        
        // Ẩn modal xóa booking
        function hideDeleteBookingModal() {
            const modal = document.getElementById('deleteBookingModal');
            modal.style.display = 'none';
            bookingToDelete = null;
        }
        
        // Hàm xóa booking
        function deleteBooking(bookingId) {
            const bookingIndex = bookings.findIndex(b => b.id === bookingId);
            if (bookingIndex === -1) return;
            
            const booking = bookings[bookingIndex];
            
            // 1. Xóa booking khỏi danh sách bookings
            bookings.splice(bookingIndex, 1);
            
            // 2. Xóa booking khỏi danh sách assignments của nhân viên
            staffData.forEach(staff => {
                // Xóa khỏi bookingsAssigned
                const bookingIndexInStaff = staff.bookingsAssigned.indexOf(bookingId);
                if (bookingIndexInStaff !== -1) {
                    staff.bookingsAssigned.splice(bookingIndexInStaff, 1);
                }
                
                // Xóa khỏi currentAssignments
                const currentIndex = staff.currentAssignments.indexOf(bookingId);
                if (currentIndex !== -1) {
                    staff.currentAssignments.splice(currentIndex, 1);
                }
                
                // Xóa roomsAssigned liên quan đến booking này
                staff.roomsAssigned = staff.roomsAssigned.filter(room => 
                    !room.includes(`(${booking.name})`)
                );
            });
            
            // 3. Nếu đang chọn booking này trong tab chia phòng, xóa selection
            if (selectedBookingId === bookingId) {
                selectedBookingId = null;
                document.getElementById('selectBooking').value = '';
                document.getElementById('bookingInfoBox').style.display = 'none';
                document.getElementById('roomAssignmentSection').style.display = 'none';
            }
            
            // 4. Hiển thị thông báo thành công
            showAlert('bookingAlert', `ĐÃ XÓA BOOKING "${booking.name}" THÀNH CÔNG!`, 'success');
            
            // 5. Lưu dữ liệu
            saveDataToStorage();
            
            // 6. Cập nhật giao diện
            updateAllUI();
        }
        
        // Hàm cập nhật danh sách booking hôm nay (có nút xóa)
        function updateTodayBookingsList() {
            const today = new Date().toISOString().split('T')[0];
            const todayBookingsList = document.getElementById('todayBookingsList');
            todayBookingsList.innerHTML = '';
            
            const todayBookings = bookings.filter(booking => booking.date === today);
            
            if (todayBookings.length === 0) {
                todayBookingsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>KHÔNG CÓ BOOKING NÀO HÔM NAY</h3>
                        <p>HÃY TẠO BOOKING MỚI BẰNG FORM BÊN TRÊN</p>
                    </div>
                `;
                return;
            }
            
            todayBookings.forEach(booking => {
                const bookingElement = document.createElement('div');
                bookingElement.className = 'booking-card booking-status-today';
                
                // Thêm nút xóa booking
                const deleteButton = `
                    <button class="btn-delete-booking" onclick="showDeleteBookingModal(${booking.id})">
                        <i class="fas fa-trash"></i> XÓA
                    </button>
                `;
                
                bookingElement.innerHTML = `
                    ${deleteButton}
                    <div class="booking-header">
                        <div class="booking-title">${booking.name}</div>
                        <div class="booking-customer-count">${booking.customers} KHÁCH</div>
                    </div>
                    <div class="booking-details">
                        <div class="detail-row">
                            <div class="detail-label">THỜI GIAN:</div>
                            <div class="detail-value">${booking.startTime} - ${booking.endTime}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">THỜI LƯỢNG:</div>
                            <div class="detail-value">${booking.durationMinutes} PHÚT</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">TRẠNG THÁI:</div>
                            <div class="detail-value"><span class="badge ${getStatusClass(booking.status)}">${getStatusText(booking.status)}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">PHÒNG:</div>
                            <div class="detail-value">${booking.rooms.length} PHÒNG</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">NV ĐÃ PHÂN:</div>
                            <div class="detail-value">${booking.assignedStaff.length} NHÂN VIÊN</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="selectBookingForAssignment(${booking.id})" style="width: 100%;">
                            <i class="fas fa-door-open"></i> CHIA PHÒNG CHO BOOKING NÀY
                        </button>
                    </div>
                `;
                
                todayBookingsList.appendChild(bookingElement);
            });
        }
        
        // Hàm chọn booking để chia phòng
        window.selectBookingForAssignment = function(bookingId) {
            document.querySelector('[data-tab="room-assignment"]').click();
            document.getElementById('selectBooking').value = bookingId;
            const event = new Event('change');
            document.getElementById('selectBooking').dispatchEvent(event);
        };
        
        // Hàm hiển thị cảnh báo
        function showAlert(alertId, message, type) {
            const alertElement = document.getElementById(alertId);
            alertElement.textContent = message.toUpperCase();
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'flex';
        }
        
        // Hàm hiển thị cảnh báo trong tab chia phòng
        function showRoomAlert(message, type) {
            showAlert('roomAlert', message, type);
        }
        
        // Hàm cập nhật trạng thái booking
        function updateBookingStatus(booking) {
            if (booking.status === 'hoan_thanh') {
                return; // Đã hoàn thành rồi thì giữ nguyên
            }
            
            if (booking.assignedStaff.length >= booking.customers) {
                booking.status = 'dang_phan_phong'; // CHỈ SỬA THÀNH 'dang_phan_phong', KHÔNG PHẢI 'hoan_thanh'
            } else if (booking.assignedStaff.length > 0) {
                booking.status = 'dang_phan_phong';
            } else {
                booking.status = 'chua_phan_phong';
            }
        }
        
        // Hàm trợ giúp
        function getStatusText(status) {
            const statusMap = {
                'chua_phan_phong': 'CHƯA PHÂN PHÒNG',
                'dang_phan_phong': 'ĐANG PHÂN PHÒNG',
                'hoan_thanh': 'HOÀN THÀNH'
            };
            return statusMap[status] || status;
        }
        
        function getStatusClass(status) {
            const classMap = {
                'chua_phan_phong': 'badge-warning',
                'dang_phan_phong': 'badge-success',
                'hoan_thanh': 'badge-success'
            };
            return classMap[status] || 'badge';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
        
        function getDayOfWeek(dateString) {
            const date = new Date(dateString);
            const days = ['CHỦ NHẬT', 'THỨ 2', 'THỨ 3', 'THỨ 4', 'THỨ 5', 'THỨ 6', 'THỨ 7'];
            return days[date.getDay()];
        }
        
        function getStartOfWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const startOfWeek = new Date(today.setDate(diff));
            return startOfWeek.toISOString().split('T')[0];
        }
        
        function getEndOfWeek() {
            const startOfWeek = new Date(getStartOfWeek());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            return endOfWeek.toISOString().split('T')[0];
        }
        
        function getStartOfNextWeek() {
            const startOfWeek = new Date(getStartOfWeek());
            const startOfNextWeek = new Date(startOfWeek);
            startOfNextWeek.setDate(startOfNextWeek.getDate() + 7);
            return startOfNextWeek.toISOString().split('T')[0];
        }
        
        function getEndOfNextWeek() {
            const startOfNextWeek = new Date(getStartOfNextWeek());
            const endOfNextWeek = new Date(startOfNextWeek);
            endOfNextWeek.setDate(endOfNextWeek.getDate() + 6);
            return endOfNextWeek.toISOString().split('T')[0];
        }
        
        // Khởi tạo ứng dụng khi trang được tải
        document.addEventListener('DOMContentLoaded', () => {
            updateTodayDate();
            
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);
            
            // Đặt giá trị mặc định cho các trường
            document.getElementById('tourDate').value = today;
            document.getElementById('tourDate').min = today;
            document.getElementById('offDate').value = today;
            document.getElementById('statDate').value = today;
            document.getElementById('filterDate').value = '';
            document.getElementById('offFilterDate').value = '';
            document.getElementById('filterCurrentDate').value = today;
            document.getElementById('filterCurrentTime').value = currentTime;
            
            // Khởi tạo dữ liệu nhân viên mặc định
            initializeStaffData();
            
            // Thử tải dữ liệu từ localStorage
            const hasData = loadDataFromStorage();
            
            if (!hasData) {
                // Tạo dữ liệu mẫu nếu không có dữ liệu đã lưu
                
                // Thêm off cho một vài nhân viên
                staffData[0].offDays.push({date: today, reason: 'NGHỈ ỐM'});
                staffData[0].isAvailableToday = false;
                staffData[0].customName = 'ANH_TUẤN';
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                staffData[1].offDays.push({date: tomorrowStr, reason: 'NGHỈ PHÉP'});
                staffData[1].customName = 'CHỊ_MAI';
                
                // Gán tên tùy chỉnh cho một số nhân viên khác
                staffData[2].customName = 'NGUYỄN_VĂN_A';
                staffData[3].customName = 'TRẦN_THỊ_B';
                staffData[4].customName = '001';
                staffData[5].customName = '002';
                
                // Thêm booking mẫu cho hôm nay
                const sampleBooking1 = {
                    id: Date.now(),
                    name: 'TOUR HÀ NỘI - HẠ LONG',
                    date: today,
                    startTime: '09:00',
                    endTime: '12:00',
                    durationMinutes: 180,
                    customers: 25,
                    notes: 'TOUR CAO CẤP',
                    status: 'dang_phan_phong',
                    rooms: [],
                    assignedStaff: [1, 2, 3, 4, 5]
                };
                
                bookings.push(sampleBooking1);
                
                // Thêm booking mẫu cho ngày mai
                const sampleBooking2 = {
                    id: Date.now() + 1,
                    name: 'TOUR SAPA 2 NGÀY 1 ĐÊM',
                    date: tomorrowStr,
                    startTime: '08:00',
                    endTime: '17:00',
                    durationMinutes: 540,
                    customers: 30,
                    notes: 'TOUR TRONG NƯỚC',
                    status: 'chua_phan_phong',
                    rooms: [],
                    assignedStaff: []
                };
                
                bookings.push(sampleBooking2);
                
                // Lưu dữ liệu mẫu
                saveDataToStorage();
            }
            
            // Cập nhật giao diện
            updateAllUI();
            
            // Tự động lưu khi đóng tab/trang
            window.addEventListener('beforeunload', function(e) {
                saveDataToStorage();
            });
            
            // Tự động lưu mỗi 30 giây
            setInterval(saveDataToStorage, 30000);
        });
    </script>
</body>
</html>